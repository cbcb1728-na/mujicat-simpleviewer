<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mujineko-Viewer Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* =========================================
   åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆPCç”¨ãƒ™ãƒ¼ã‚¹ï¼‰
========================================= */
:root {
  --control-bg: #f8f9fa;
  --border-color: #ddd;
  --viewer-bg: #1a1a1a;
  --accent-color: #0056b3;
}

body {
  margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif;
  color: #333; touch-action: none;
}

button { cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; padding: 6px 10px; font-size: 13px; transition: 0.2s; touch-action: manipulation; }
button:hover { background: #e9ecef; }
button:disabled { opacity: 0.6; cursor: not-allowed; }

/* ä¸Šéƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆ1è¡Œå›ºå®šãƒ»æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
#topBar {
  padding: 6px 10px; background: var(--control-bg); border-bottom: 1px solid var(--border-color);
  display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; justify-content: flex-start; 
  z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch;
}
#topBar::-webkit-scrollbar { height: 4px; }
#topBar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

.left-controls, .right-controls { display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; }
.control-group { display: flex; gap: 4px; align-items: center; border-right: 1px solid #ccc; padding-right: 8px; }
.control-group:last-child { border-right: none; }

#manifestUrl { font-size: 13px; padding: 6px; width: 160px; border: 1px solid #ccc; border-radius: 4px; }
#pageSelect { font-size: 13px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }

/* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
#mainArea { flex: 1; position: relative; display: flex; overflow: hidden; background: var(--viewer-bg); }
#viewer { flex: 1; height: 100%; width: 100%; }

/* èª­æ›¸ç”¨ã‚¬ã‚¤ãƒ‰ç·šï¼ˆ3pxï¼‰ */
#readingGuide {
  position: absolute; top: 0; left: 50%; width: 3px; height: 100%;
  background: rgba(220, 53, 69, 0.8); z-index: 999;
  display: none; box-shadow: 0 0 4px rgba(255,255,255,0.5);
  cursor: ew-resize; touch-action: none;
}
#readingGuide::before { content: ""; position: absolute; top: 0; left: -25px; right: -25px; bottom: 0; }
#readingGuide.active { display: block; }

/* ç”»åƒèª¿æ•´ãƒœã‚¿ãƒ³ï¼ˆPCæ™‚ã¯å·¦ç«¯ä¸­å¤®ï¼‰ */
#viewerControls {
  position: absolute; top: 50%; left: 10px; transform: translateY(-50%); z-index: 50;
  display: flex; flex-direction: column; gap: 4px; background: rgba(255, 255, 255, 0.85);
  padding: 4px; border-radius: 6px; backdrop-filter: blur(4px); box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
#viewerControls button { font-size: 12px; padding: 0; width: 30px; height: 30px; border: 1px solid #aaa; font-weight: bold; }
.v-divider { height: 1px; width: 100%; background: #aaa; margin: 2px 0; }

/* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã™ã‚‹ãƒ¡ãƒ¢ãƒ‘ãƒãƒ« */
#notesPanel {
  position: absolute; top: 0; right: -360px; 
  width: 360px; height: 100%; background: #fff; box-shadow: -4px 0 15px rgba(0,0,0,0.2);
  transition: right 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 60;
  display: flex; flex-direction: column;
}
#notesPanel.open { right: 0; }

/* ãƒ¡ãƒ¢ãƒ‘ãƒãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¿å­˜ãƒ»èª­è¾¼ãƒœã‚¿ãƒ³ã‚’ãŠå¼•è¶Šã—ï¼‰ */
#notesHeader { 
  padding: 8px 10px; background: #f0f0f0; border-bottom: 1px solid #ddd; 
  display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; 
}
.note-header-buttons { display: flex; gap: 4px; }
.note-header-buttons button { padding: 4px 8px; font-size: 11px; }

#globalNoteSection { height: 50%; display: flex; flex-direction: column; flex-shrink: 0; }
#pageNoteSection { flex: 1; display: flex; flex-direction: column; min-height: 0; }
.note-title { padding: 6px 10px; font-size: 11px; font-weight: bold; color: #555; background: #fafafa; border-bottom: 1px solid #eee; flex-shrink: 0; }
.note-textarea { flex: 1; width: 100%; box-sizing: border-box; resize: none; border: none; padding: 10px; font-size: 14px; line-height: 1.6; outline: none; touch-action: pan-y; }
.resizer-h { height: 8px; background: #e0e0e0; cursor: row-resize; flex-shrink: 0; border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; }

.btn-primary { background: var(--accent-color); color: #fff; border-color: var(--accent-color); font-weight: bold; }
.btn-action { font-weight: bold; color: #333; }
.btn-save { font-weight: bold; color: #006600; background: #e6ffe6; border-color: #b3ffb3; }

/* =========================================
   ğŸ“± ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
========================================= */
@media (max-width: 768px) {
  /* ãƒˆãƒƒãƒ—ãƒãƒ¼ã‚’å®Œå…¨ã«1è¡Œã«ã—ã¦ã€æ¨ªã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
  #topBar { padding: 6px; }
  #topBar::-webkit-scrollbar { display: none; } /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ */
  #manifestUrl { width: 110px; } /* ã‚¹ãƒãƒ›ã§ã¯URLæ¬„ã‚’çŸ­ã */

  /* ç”»åƒèª¿æ•´ãƒœã‚¿ãƒ³ã‚’ç”»é¢ã€Œä¸‹éƒ¨ä¸­å¤®ã€ã«æ¨ªä¸¦ã³é…ç½® */
  #viewerControls {
    top: auto; bottom: 20px; left: 50%; transform: translateX(-50%);
    flex-direction: row; border-radius: 20px; padding: 6px 12px; gap: 8px;
  }
  #viewerControls button { width: 36px; height: 36px; font-size: 14px; border-radius: 50%; }
  .v-divider { height: 36px; width: 1px; margin: 0 4px; }

  /* ãƒ¡ãƒ¢ãƒ‘ãƒãƒ«ã¯ã€Œä¸‹ã‹ã‚‰ã€ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ— */
  #notesPanel {
    top: auto; bottom: -65vh; right: 0; left: 0;
    width: 100%; height: 60vh; border-radius: 12px 12px 0 0;
  }
  #notesPanel.open { bottom: 0; right: 0; }
}
</style>
</head>
<body>

<div id="topBar">
  <div class="left-controls">
    <div class="control-group">
      <input type="text" id="manifestUrl" placeholder="IIIF URL">
      <button onclick="loadManifest()" class="btn-primary">èª­è¾¼</button>
    </div>
    <div class="control-group">
      <button onclick="nextPage()">â—€</button>
      <select id="pageSelect" onchange="jumpPage(this.value)"></select>
      <button onclick="prevPage()">â–¶</button>
    </div>
  </div>
  
  <div class="right-controls">
    <div class="control-group">
      <button onclick="downloadFullImage()" class="btn-action">â¬‡ï¸ 1é </button>
      <button onclick="downloadMultipleZip()" class="btn-action" id="btnMultiZip">ğŸ—‚ï¸ ZIP</button>
      <button onclick="downloadMultiplePdf()" class="btn-action" id="btnMultiPdf">ğŸ“„ PDF</button>
    </div>
    <div class="control-group" style="border-right: none;">
      <button onclick="toggleNotes()" class="btn-action" style="background:#fff3cd;">ğŸ“ ãƒ¡ãƒ¢ã‚’é–‹ã</button>
    </div>
  </div>
</div>

<div id="mainArea">
  <div id="readingGuide"></div>

  <div id="viewerControls">
    <button onclick="toggleGuide()" title="èª­æ›¸ç”¨ã‚¬ã‚¤ãƒ‰ç·š">ç·š</button>
    <div class="v-divider"></div>
    <button onclick="toggleFilter('contrast')" title="ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿">æ¿ƒ</button>
    <button onclick="toggleFilter('invert')" title="ç™½é»’åè»¢">è»¢</button>
    <button onclick="resetFilters()">è§£</button>
    <div class="v-divider"></div>
    <button onclick="rotate(-90)">â†¶</button>
    <button onclick="rotate(90)">â†·</button>
  </div>
  
  <div id="viewer"></div>

  <div id="notesPanel">
    <div id="notesHeader">
      <span style="font-weight: bold; font-size: 13px;">ğŸ“ ãƒ¡ãƒ¢</span>
      <div class="note-header-buttons">
        <button onclick="exportSession()" class="btn-save">ğŸ’¾ ä¿å­˜</button>
        <button onclick="document.getElementById('sessionLoader').click()" class="btn-action">ğŸ“‚ èª­è¾¼</button>
        <input type="file" id="sessionLoader" style="display:none" accept=".json">
        <button onclick="toggleNotes()" style="background:#ffe6e6;">âœ– é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div id="globalNoteSection">
      <div class="note-title">å…¨ä½“ãƒ¡ãƒ¢ï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰</div>
      <textarea id="globalNotesTextarea" class="note-textarea" placeholder="ä½œå“å…¨ä½“ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢"></textarea>
    </div>
    <div id="noteResizer" class="resizer-h"></div>
    <div id="pageNoteSection">
      <div class="note-title">å„é ãƒ¡ãƒ¢ï¼ˆç¾åœ¨ã®ãƒšãƒ¼ã‚¸ï¼‰</div>
      <textarea id="pageNotesTextarea" class="note-textarea" placeholder="è¡¨ç¤ºä¸­ã®ãƒšãƒ¼ã‚¸ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢"></textarea>
    </div>
  </div>
</div>

<script>
let images = [], notesData = [], globalNote = "", currentPage = 0;
let filterState = { contrast: false, invert: false };

const pSelect = document.getElementById("pageSelect");
const globalTextarea = document.getElementById("globalNotesTextarea");
const pageTextarea = document.getElementById("pageNotesTextarea");
const notesPanel = document.getElementById("notesPanel");

const viewer = OpenSeadragon({
  id: "viewer", prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
  showNavigator: true, navigatorPosition: "BOTTOM_LEFT", navigatorWidth: "80px", navigatorHeight: "80px",
  animationTime: 0.4, gestureSettingsMouse: { clickToZoom: true },
  preserveViewport: true, visibilityRatio: 0.5
});

let isResizingNote = false;
const noteResizer = document.getElementById("noteResizer");
const globalNoteSection = document.getElementById("globalNoteSection");
const notesHeader = document.getElementById("notesHeader");

noteResizer.addEventListener("mousedown", (e) => { isResizingNote = true; document.body.style.cursor = 'row-resize'; e.preventDefault(); });
document.addEventListener("mousemove", (e) => handleResize(e.clientY));
document.addEventListener("mouseup", () => { if(isResizingNote) { isResizingNote = false; document.body.style.cursor = ''; } });

noteResizer.addEventListener("touchstart", (e) => { isResizingNote = true; e.preventDefault(); }, {passive: false});
document.addEventListener("touchmove", (e) => { if(isResizingNote) handleResize(e.touches[0].clientY); }, {passive: false});
document.addEventListener("touchend", () => { isResizingNote = false; });

function handleResize(clientY) {
    if (!isResizingNote) return;
    const panelRect = notesPanel.getBoundingClientRect();
    const headerHeight = notesHeader.offsetHeight;
    let y = clientY - panelRect.top - headerHeight;
    const availableHeight = panelRect.height - headerHeight - noteResizer.offsetHeight;
    let percentage = (y / availableHeight) * 100;
    if (percentage < 10) percentage = 10; if (percentage > 90) percentage = 90;
    globalNoteSection.style.height = percentage + "%";
}

function toggleNotes() { notesPanel.classList.toggle('open'); }
function toggleGuide() { document.getElementById('readingGuide').classList.toggle('active'); }

function applyFilters() {
    const canvases = document.querySelectorAll('#viewer canvas');
    let s = "";
    if (filterState.contrast) s += "contrast(250%) grayscale(80%) ";
    if (filterState.invert) s += "invert(100%) ";
    canvases.forEach(c => { c.style.filter = s.trim(); });
}
function toggleFilter(t) { filterState[t] = !filterState[t]; applyFilters(); }
function resetFilters() { filterState = { contrast: false, invert: false }; applyFilters(); viewer.viewport.setRotation(0); viewer.viewport.goHome(); }
function rotate(d) { viewer.viewport.setRotation(viewer.viewport.getRotation() + d); }

function autoSave() {
    localStorage.setItem("viewer_images", JSON.stringify(images));
    localStorage.setItem("viewer_notes", JSON.stringify(notesData));
    localStorage.setItem("viewer_global_note", globalNote);
    localStorage.setItem("viewer_page", currentPage);
}
function autoLoad() {
    images = JSON.parse(localStorage.getItem("viewer_images")) || [];
    notesData = JSON.parse(localStorage.getItem("viewer_notes")) || [];
    globalNote = localStorage.getItem("viewer_global_note") || "";
    currentPage = parseInt(localStorage.getItem("viewer_page")) || 0;
    globalTextarea.value = globalNote;
    if (images.length > 0) { updatePageInfo(); loadPage(); }
}
window.addEventListener('DOMContentLoaded', autoLoad);

function saveNotes() { notesData[currentPage] = pageTextarea.value; globalNote = globalTextarea.value; autoSave(); }
pageTextarea.addEventListener("input", saveNotes);
globalTextarea.addEventListener("input", saveNotes);

function exportSession() {
    saveNotes();
    const data = { images, notesData, globalNote, currentPage };
    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "viewer_session.json"; a.click();
}
document.getElementById("sessionLoader").addEventListener("change", function(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = JSON.parse(ev.target.result);
            images = data.images || []; notesData = data.notesData || [];
            globalNote = data.globalNote || ""; currentPage = data.currentPage || 0;
            globalTextarea.value = globalNote; updatePageInfo(); loadPage();
            alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
        } catch(err) { alert("å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    };
    reader.readAsText(file); e.target.value = "";
});

async function loadManifest() {
    const url = document.getElementById('manifestUrl').value.trim(); if (!url) return;
    try {
        const res = await fetch(url); const json = await res.json();
        let canvases = (json.sequences) ? json.sequences[0].canvases : json.items;
        images = canvases.map(c => {
            if (c.images) return c.images[0].resource.service['@id'] + '/info.json';
            if (c.items) return c.items[0].items[0].body.service[0]['@id'] || c.items[0].items[0].body.service['id'];
            return null;
        }).filter(Boolean);
        notesData = new Array(images.length).fill(""); globalNote = ""; globalTextarea.value = ""; currentPage = 0;
        loadPage(); alert("IIIFã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
    } catch (e) { alert("èª­ã¿è¾¼ã¿å¤±æ•—"); }
}

function loadPage() {
    const imgUrl = images[currentPage]; if (imgUrl) viewer.open(imgUrl);
    pageTextarea.value = notesData[currentPage] || ""; updatePageInfo(); autoSave();
}
function updatePageInfo() {
    const total = images.length || 1; pSelect.innerHTML = "";
    for (let i = 0; i < total; i++) {
        const opt = document.createElement("option"); opt.value = i; opt.innerText = (i + 1) + " / " + total;
        if (i === currentPage) opt.selected = true; pSelect.appendChild(opt);
    }
}
function jumpPage(val) { saveNotes(); currentPage = parseInt(val); loadPage(); }
function prevPage() { if (currentPage > 0) { saveNotes(); currentPage--; loadPage(); } }
function nextPage() { if (currentPage < images.length - 1) { saveNotes(); currentPage++; loadPage(); } }

async function downloadFullImage() {
    const imgUrl = images[currentPage]; if (!imgUrl) return alert("ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    const downloadUrl = imgUrl.replace(/\/info\.json$/, '/full/full/0/default.jpg');
    try {
        const response = await fetch(downloadUrl); const blob = await response.blob();
        const url = window.URL.createObjectURL(blob); const a = document.createElement('a');
        a.style.display = 'none'; a.href = url; a.download = `page_${currentPage + 1}.jpg`;
        document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
    } catch (e) { window.open(downloadUrl, '_blank'); }
}

function getPageRange() {
    if (images.length === 0) return null;
    const input = prompt(`ä¿å­˜ç¯„å›² (ä¾‹: 1-5)\nâ€»æœ€å¤§: ${images.length}`);
    if (!input) return null;
    const parts = input.split('-'); if (parts.length !== 2) return null;
    const start = parseInt(parts[0]) - 1, end = parseInt(parts[1]) - 1;
    if (isNaN(start) || isNaN(end) || start < 0 || end >= images.length || start > end) return null;
    return { start, end };
}

async function downloadMultipleZip() {
    const range = getPageRange(); if (!range) return;
    const { start, end } = range; const btn = document.getElementById('btnMultiZip'); 
    const originalText = btn.innerText; btn.innerText = "â³ å‡¦ç†ä¸­"; btn.disabled = true;
    try {
        const zip = new JSZip(); let successCount = 0;
        for (let i = start; i <= end; i++) {
            const imgUrl = images[i].replace(/\/info\.json$/, '/full/full/0/default.jpg');
            try {
                const response = await fetch(imgUrl); if (!response.ok) throw new Error("error");
                zip.file(`page_${String(i + 1).padStart(3, '0')}.jpg`, await response.blob()); successCount++;
                btn.innerText = `â³ ${successCount}/${end - start + 1}`;
            } catch (err) {}
        }
        if (successCount > 0) {
            const content = await zip.generateAsync({ type: "blob" });
            const url = window.URL.createObjectURL(content); const a = document.createElement('a');
            a.href = url; a.download = `images_${start + 1}-${end + 1}.zip`; a.click(); window.URL.revokeObjectURL(url);
        }
    } finally { btn.innerText = originalText; btn.disabled = false; }
}

async function downloadMultiplePdf() {
    const range = getPageRange(); if (!range) return;
    const { start, end } = range; const btn = document.getElementById('btnMultiPdf'); 
    const originalText = btn.innerText; btn.innerText = "â³ å‡¦ç†ä¸­"; btn.disabled = true;
    try {
        const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'pt', 'a4'); 
        let isFirstPage = true; let successCount = 0;
        for (let i = start; i <= end; i++) {
            const imgUrl = images[i].replace(/\/info\.json$/, '/full/full/0/default.jpg');
            try {
                const response = await fetch(imgUrl); const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob); const img = new Image(); img.src = objectUrl;
                await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });
                const orientation = img.width > img.height ? 'l' : 'p';
                if (isFirstPage) { pdf.deletePage(1); pdf.addPage([img.width, img.height], orientation); isFirstPage = false; } 
                else { pdf.addPage([img.width, img.height], orientation); }
                const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, img.width, img.height);
                URL.revokeObjectURL(objectUrl); successCount++; btn.innerText = `â³ ${successCount}/${end - start + 1}`;
            } catch (err) {}
        }
        if (successCount > 0) pdf.save(`document_${start + 1}-${end + 1}.pdf`);
    } finally { btn.innerText = originalText; btn.disabled = false; }
}

document.addEventListener('keydown', function(event) {
    const activeTag = event.target.tagName.toLowerCase();
    if (activeTag === 'input' || activeTag === 'textarea') return;
    if (event.key === 'ArrowLeft') { event.preventDefault(); event.stopPropagation(); nextPage(); } 
    else if (event.key === 'ArrowRight') { event.preventDefault(); event.stopPropagation(); prevPage(); }
}, true);

const readingGuide = document.getElementById('readingGuide');
let isDraggingGuide = false;

readingGuide.addEventListener('mousedown', function(e) {
    isDraggingGuide = true; document.body.style.cursor = 'ew-resize';
    document.body.style.userSelect = 'none'; e.preventDefault(); e.stopPropagation();
});
document.addEventListener('mousemove', function(e) {
    if (isDraggingGuide) readingGuide.style.left = e.clientX + 'px';
});
document.addEventListener('mouseup', function() {
    if (isDraggingGuide) { isDraggingGuide = false; document.body.style.cursor = ''; document.body.style.userSelect = ''; }
});

readingGuide.addEventListener('touchstart', function(e) {
    isDraggingGuide = true; document.body.style.userSelect = 'none';
    e.preventDefault(); e.stopPropagation();
}, {passive: false});
document.addEventListener('touchmove', function(e) {
    if (isDraggingGuide) readingGuide.style.left = e.touches[0].clientX + 'px';
}, {passive: false});
document.addEventListener('touchend', function() {
    if (isDraggingGuide) { isDraggingGuide = false; document.body.style.userSelect = ''; }
});
</script>
</body>
</html>

